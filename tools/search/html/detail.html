<style>
    .content {
        width: 100% !important;
    }
</style>

<div style="height: 100%;" id="editor" data-type="{{status}}" data-filename="{{filename}}" data-content="{{content}}" style="width:100%;height:1024px;"></div>

<script>
    var require = {
        paths: {
            'vs': '/static/vs'
        }
    };
</script>
<script src="/static/vs/loader.js"></script>
<script src="/static/vs/editor/editor.main.nls.js"></script>
<script src="/static/vs/editor/editor.main.js"></script>
<script>
    require(["vs/editor/editor.main"], function() {
        var editorElement = document.getElementById("editor");
        var changeType = editorElement.getAttribute("data-type");

        const language_map = {
            'css': 'css',
            'md': 'markdown',
            'js': 'javascript',
            'ts': 'typescript',
            'py': 'python',
            'sh': 'bash',
            'rs': 'rust',
            'cc': 'c',
            'c': 'c',
            'cpp': 'c',
        };
        const extension = editorElement.getAttribute("data-filename").split(".").pop();
        const language = language_map[extension] || 'text/plain';

        var content = atob(editorElement.getAttribute("data-content"));
        const editor = monaco.editor.create(editorElement, {
            readOnly: true,
            value: content,
            language: language,
            theme: "vs",
            minimap: {
                enabled: false
            }
        });

        editor.addAction({
            // An unique identifier of the contributed action.
            id: 'permalink',

            // A label of the action that will be presented to the user.
            label: 'Copy permalink',

            contextMenuGroupId: 'navigation',
            contextMenuOrder: 1.5,

            // Method that will be executed when the action is triggered.
            // @param editor The editor instance is passed in as a convinience
            run: function(ed) {
                window.location.hash = "#L" + ed.getPosition().lineNumber
                const url = window.location.protocol + "//" + window.location.host + window.location.pathname + "#L" + ed.getPosition().lineNumber
                navigator.clipboard.writeText(url)
                return null;
            }
        });

        editor.addAction({
            // An unique identifier of the contributed action.
            id: 'search',

            // A label of the action that will be presented to the user.
            label: 'Search for this token',

            contextMenuGroupId: 'navigation',
            contextMenuOrder: 1.5,

            run: function(ed) {
                const selection = ed.getSelection()
                const word = ed.getModel().getWordAtPosition(ed.getPosition()).word
                const url = window.location.protocol + "//" + window.location.host + "?q=" + word
                window.open(url, '_blank');
                return null;
            }
        });

        editor.addAction({
            // An unique identifier of the contributed action.
            id: 'search',

            // A label of the action that will be presented to the user.
            label: 'Search for this token\'s definition',

            contextMenuGroupId: 'navigation',
            contextMenuOrder: 1.5,

            run: function(ed) {
                const selection = ed.getSelection()
                const word = ed.getModel().getWordAtPosition(ed.getPosition()).word
                const url = window.location.protocol + "//" + window.location.host + "?q=def:" + word
                window.open(url, '_blank');
                return null;
            }
        });

        if (window.location.hash.startsWith("#L")) {
            const line = parseInt(window.location.hash.substring(2));
            editor.setPosition({
                column: 1,
                lineNumber: line
            });
            editor.revealLineInCenter(line + 10);
        }
    });
</script>
